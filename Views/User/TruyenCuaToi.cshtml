@model PagedList.IPagedList<Web_truyen.ViewModel.TruyenCuaToiViewModel>
@using PagedList
@using PagedList.Mvc
@{
    ViewBag.TitlePage = "Truyện của tôi";
    Layout = "~/Views/Share/_LayoutPage.cshtml";
    var currentUser = Web_truyen.App_Start.SessionConfig.GetUser();
    var userId = currentUser != null ? currentUser.userId : 0;

}
<link href="~/Assets/css/User/TruyenCuaToi.css" rel="stylesheet" />
@section top {
    @Html.Partial("~/Views/Share/_MenuHeadU.cshtml")
}
<div class="container_title">
    <h2>Truyện của tôi</h2>
    <button class="new-story">+ Truyện mới</button>
</div>
<div class="container">
    <div class="tab-menu">
        <div class="filter-item @(ViewBag.CurrentFilter == "all" ? "active" : "")">
            <a href="@Url.Action("TruyenCuaToi", "User", new { userId = userId, filter = "all" })">Tất cả</a>
        </div>
        <div class="filter-item @(ViewBag.CurrentFilter == "dadang" ? "active" : "")">
            <a href="@Url.Action("TruyenCuaToi", "User", new { userId = userId, filter = "dadang" })">Truyện đã đăng</a>
        </div>
    </div>
    <div class="story-list">
        @foreach (var item in Model)
        {
            <!-- Truyện có chương đã đăng -->
            <div class="story-card">
                <div class="story-content">
                    <div class="story-info">
                        <img src="@Url.Content("~/Assets/img/" + item.AnhBia)" alt="Ảnh truyện" />
                        <div class="story-text">
                            <h2 class="story-title">@item.TieuDe</h2>
                            <p class="story-status">
                                <span>@item.SoChuongDaDang đã đăng</span> - @item.SoBanThao bản thảo
                            </p>

                            @{
                                var timeDiff = DateTime.Now - item.NgayCapNhat;
                                string updateText;

                                if (timeDiff.TotalMinutes < 1)
                                {
                                    updateText = "Vừa xong";
                                }
                                else if (timeDiff.TotalMinutes < 60)
                                {
                                    updateText = $"{(int)timeDiff.TotalMinutes} phút trước";
                                }
                                else if (timeDiff.TotalHours < 24)
                                {
                                    updateText = $"{(int)timeDiff.TotalHours} giờ trước";
                                }
                                else if (timeDiff.TotalDays < 7)
                                {
                                    updateText = $"{(int)timeDiff.TotalDays} ngày trước";
                                }
                                else
                                {
                                    updateText = item.NgayCapNhat.ToString("dd/MM/yyyy");
                                }
                            }
                            <p class="story-update">Cập nhật: @updateText</p>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="write-button">
                            Tiếp tục viết
                            <span class="caret-down"><i class="fas fa-caret-down"></i></span>
                        </button>
                        <div class="top-buttons" style="position: relative;">
                            @if (item.SoChuongDaDang > 0)
                            {
                                <button class="stats-button">Thống kê</button>
                            }
                            <div class="more-options-wrapper" style="position: relative; display: inline-block;">
                                <button class="more-options" onclick="togglePopup(this)">...</button>
                                <div class="popup-menu">
                                    @if (item.SoChuongDaDang > 0)
                                    {
                                        <button class="preview-btn">
                                            <i class="fas fa-eye"></i> Xem trước
                                        </button>
                                        <button class="pause-btn">
                                            <i class="fas fa-pause-circle"></i> Dừng đăng tải
                                        </button>
                                    }
                                    <button class="delete-btn">
                                        <i class="fas fa-trash-alt"></i> Xóa truyện
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

                <!-- Popup mục lục -->
                <div class="chapter-popup" style="display:none;">
                    @{
                        ViewBag.ControllerName = "Edit";
                        ViewBag.ActionName = "Chuong";
                        ViewBag.IsDocChuong = true;
                        ViewBag.AreaName = "Admin";
                        ViewBag.HienThiNutThemChuong = true;
                    }
                    @Html.Partial("~/Areas/Admin/Views/Chuong/MucLuc.cshtml", new Tuple<List<Web_truyen.Models.Chuong>, int>(ViewBag.DanhSachChuong, ViewBag.ChuongDangChon ?? 0))
                </div>


            </div>
        }
    </div>

</div>
<script src="~/Assets/js/User/TruyenCuaToi.js"></script>